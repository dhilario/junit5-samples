<project name="bws">

	<defaultexcludes add="**/_svn" />
	<defaultexcludes add="**/_svn/**" />

	<property file="custom.properties" />
	<property file="default.properties" />
	<property environment="env" />
	<property name="version" value="${env.JOB_NAME}-b${env.BUILD_NUMBER}"/>
	
	<path id="master-classpath">
		<fileset dir="libs">
			<include name="*.jar"/>
			<exclude name="gwt-dev.jar"/>
		</fileset>
		<pathelement location="src/main/java"/>
		<pathelement location="build/webapp/WEB-INF/classes"/>
	</path>
	
	<!-- separate classpath of javac and gwtc due to HttpUnit jar conflict -->
	<path id="master-classpath-gwtc">
		<path refid="master-classpath"/>
		<fileset dir="libs">
			<include name="gwt-dev.jar"/>
		</fileset>
	</path>
	
	<path id="junit-classpath">
		<fileset dir="libs">
			<include name="*.jar"/>
		</fileset>
		<pathelement location="src/test/java"/>
		<pathelement location="build/webapp/WEB-INF/classes"/>
		<pathelement location="build/junit/classes"/>		
	</path>

	<target name="build">
		
		<copy todir="${build.war.dir}">
			<fileset dir="${src.webapp.dir}">
				<include name="BWS.html" />
				<include name="BWS.css" />
				<include name="sitemap.xml" />
				<include name="favicon.ico" />
				<include name="images/*" />
				<include name="jsp/*" />
			</fileset>
		</copy>
		
		<copy todir="${build.war.dir}/WEB-INF">			
			<fileset dir="${src.webapp.dir}/WEB-INF">
				<include name="web.xml" />
				<include name="appengine-web.xml" />
				<include name="bwsApplicationContext.xml" />
				<include name="logging.properties" />
				<include name="application.properties" />
				<include name="jdbc.properties" />
				<include name="mail.properties" />
				<include name="44472ae695e6717460dc0030afddc9b3193c7b02-privatekey.p12" />
			</fileset>
		</copy>
		
		<copy todir="${build.war.dir}/WEB-INF/lib">
			<fileset dir="${src.webapp.dir}/WEB-INF/lib" />
		</copy>
		
		<copy todir="${build.dir}/database">
			<fileset dir="${src.database.dir}" />
		</copy>
		
		<replace file="${build.war.dir}/WEB-INF/jdbc.properties" propertyFile="db-default.properties">
			<replacefilter token="@db.name@" property="db.name" />
            <replacefilter token="@db.url@" property="db.url" />
            <replacefilter token="@db.user@" property="db.user" />
            <replacefilter token="@db.password@" property="db.password" />
            <replacefilter token="@db.driver@" property="db.driver" />
        </replace>
	</target>
	
	<target name="jetty-start">
	    <java jar="${jetty.home}/start.jar" fork="true" spawn="true">
	        <jvmarg value="-Djetty.home=${jetty.home}"/>
	    	<jvmarg value="-DSTOP.PORT=8079"/>
	        <jvmarg value="-DSTOP.KEY=dsww"/>
	    </java>
	</target>

	<target name="jetty-stop">
	    <java jar="${jetty.home}/start.jar" fork="true">
	    	<jvmarg value="-Djetty.home=${jetty.home}"/>
	    	<jvmarg value="-DSTOP.PORT=8079"/>
	    	<jvmarg value="-DSTOP.KEY=dsww"/>
	    	<arg line="--stop"/>
	    </java>
	</target>

	
	<target name="javac" depends="build">
		<mkdir dir="${build.war.dir}/WEB-INF/classes" />
		<javac srcdir="${src.dir}"
		         destdir="${build.war.dir}/WEB-INF/classes"
		         debug="on" classpathref="master-classpath">
			<compilerarg value="-version"/>
			<exclude name="**/*Test.java"/>
		</javac>
		<!-- copy necessary properties to classpath here -->
		<copy todir="${build.war.dir}/WEB-INF/classes">
			<fileset dir="${src.dir}">
				<include name="template/*" />
			</fileset>
		</copy>
	</target>
	
	<target name="javac-junit" depends="javac">
		<mkdir dir="${junit.classes.dir}" />
		<javac srcdir="${junit.src.dir}"
		         destdir="${junit.classes.dir}"
		         debug="on" classpathref="master-classpath"/>
	</target>
	
	<target name="gwtc" depends="javac" description="GWT compile to JavaScript">
		<!-- copy to classpath the build version metadata -->
		<replace file="${src.dir}/com/dsww/bws/client/BwsVersion.properties">
            <replacefilter token="development" value="${version}" />
        </replace>
		<java failonerror="true" fork="true"
				classname="com.google.gwt.dev.Compiler">
			<classpath refid="master-classpath-gwtc"/>
			<jvmarg value="-Xss16M"/>
			<jvmarg value="-Xmx1024M"/>
			<jvmarg value="-Dfile.encoding=utf-8"/>
			<!--
				Some GXT components don't seem to be compatible with this compiler.
				<arg value="-XenableClosureCompiler"/>
			-->
			<arg value="-war"/>
			<arg value="build/webapp"/>
			<arg value="com.dsww.bws.bws"/>
		</java>
	</target>

	<!-- 
		Put all editing/tokenizing of properties here outside of development mode (build target).
	 -->
	<target name="edit-properties">
		<replace file="${build.war.dir}/WEB-INF/mail.properties">
			<replacefilter token="development" value="build"/>
        </replace>
	</target>
	
	<target name="deploy" depends="jetty-stop,clean,gwtc,edit-properties">
		<mkdir dir="${jetty.deploy.dir}" />
		<copy todir="${jetty.deploy.dir}">
			<fileset dir="${build.war.dir}">			
				<include name="**/*" />
			</fileset>
		</copy>
	</target>
	
	<target name="deploy-with-junit" depends="deploy,junitreport,jetty-start" />

	<target name="clean">
		<delete dir="${build.dir}" ></delete>
		<delete dir="${jetty.deploy.dir}" ></delete>
	</target>
	
	<target name="junit" depends="javac-junit">
		<mkdir dir="${junit.report.dir}" />
		<junit printsummary="yes">
			<classpath refid="junit-classpath" />
			<formatter type="xml" />
			<batchtest todir="${junit.report.dir}">
			    <fileset dir="${junit.classes.dir}" includes="**/*Test.class" />
			</batchtest>
		</junit>
	</target>
	
	<target name="junitreport" depends="junit">
        <junitreport todir="${junit.report.dir}">
            <fileset dir="${junit.report.dir}" includes="TEST-*.xml"/>
            <report todir="${junit.report.dir}"/>
        </junitreport>
    </target>
</project>